<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆæµ‹è¯• - åˆ†ç±»æŸ¥è¯¢åŠŸèƒ½</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; }
        .step.completed { border-left-color: #28a745; background: #f8fff9; }
        .step.failed { border-left-color: #dc3545; background: #fff8f8; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background: #f8f9fa; font-weight: bold; }
        .badge { padding: 2px 6px; border-radius: 3px; font-size: 11px; }
        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æœ€ç»ˆåŠŸèƒ½æµ‹è¯•</h1>
        <p>éªŒè¯åˆ†ç±»æŸ¥è¯¢ç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½</p>
        
        <div class="test-section info">
            <h3>ğŸ“ ç¯å¢ƒä¿¡æ¯</h3>
            <div id="envInfo"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ å®Œæ•´æµ‹è¯•æµç¨‹</h3>
            <button onclick="runCompleteTest()" id="testBtn">å¼€å§‹å®Œæ•´æµ‹è¯•</button>
            <div id="testProgress"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ å¿«æ·æ“ä½œ</h3>
            <button onclick="window.open('category_query.html', '_blank')">æ‰“å¼€åˆ†ç±»æŸ¥è¯¢é¡µé¢</button>
            <button onclick="window.open('simple_test.html', '_blank')">æ‰“å¼€ç®€å•æµ‹è¯•é¡µé¢</button>
            <button onclick="window.open('debug_connection.html', '_blank')">æ‰“å¼€è°ƒè¯•å·¥å…·</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.5.0/dist/axios.min.js"></script>
    <script>
        // è·å–åç«¯æœåŠ¡åœ°å€
        function getBaseURL() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            return `${protocol}//${hostname}:8081`;
        }

        const baseURL = getBaseURL();
        let testResults = [];

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvironmentInfo() {
            const envInfo = document.getElementById('envInfo');
            envInfo.innerHTML = `
                <strong>å½“å‰é¡µé¢åœ°å€:</strong> ${window.location.href}<br>
                <strong>æ£€æµ‹åˆ°çš„åç«¯åœ°å€:</strong> ${baseURL}<br>
                <strong>æµè§ˆå™¨:</strong> ${navigator.userAgent.split(' ')[0]}<br>
                <strong>Origin:</strong> ${window.location.origin}<br>
                <strong>æ—¶é—´:</strong> ${new Date().toLocaleString()}
            `;
        }

        // æ·»åŠ æµ‹è¯•æ­¥éª¤
        function addTestStep(message, status = 'info') {
            const progressDiv = document.getElementById('testProgress');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${status}`;
            stepDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            progressDiv.appendChild(stepDiv);
            console.log(`[${status.toUpperCase()}] ${message}`);
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showTestResults() {
            const resultsDiv = document.getElementById('testResults');
            const passedTests = testResults.filter(t => t.passed).length;
            const totalTests = testResults.length;
            
            let html = `
                <h4>æµ‹è¯•æ€»ç»“: ${passedTests}/${totalTests} é€šè¿‡</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æµ‹è¯•é¡¹ç›®</th>
                            <th>çŠ¶æ€</th>
                            <th>å“åº”æ—¶é—´</th>
                            <th>è¯¦æƒ…</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            testResults.forEach(test => {
                html += `
                    <tr>
                        <td>${test.name}</td>
                        <td><span class="badge ${test.passed ? 'badge-success' : 'badge-danger'}">${test.passed ? 'é€šè¿‡' : 'å¤±è´¥'}</span></td>
                        <td>${test.responseTime}ms</td>
                        <td>${test.details}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            if (passedTests === totalTests) {
                html += '<div class="success" style="margin-top: 15px; padding: 10px;"><strong>ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ‚¨çš„åˆ†ç±»æŸ¥è¯¢ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚</strong></div>';
            } else {
                html += '<div class="error" style="margin-top: 15px; padding: 10px;"><strong>âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚</strong></div>';
            }
            
            resultsDiv.innerHTML = html;
        }

        // æ‰§è¡Œå•ä¸ªæµ‹è¯•
        async function runTest(name, testFunction) {
            const startTime = Date.now();
            try {
                const result = await testFunction();
                const responseTime = Date.now() - startTime;
                testResults.push({
                    name,
                    passed: true,
                    responseTime,
                    details: result || 'æˆåŠŸ'
                });
                addTestStep(`âœ… ${name} - é€šè¿‡ (${responseTime}ms)`, 'completed');
                return true;
            } catch (error) {
                const responseTime = Date.now() - startTime;
                testResults.push({
                    name,
                    passed: false,
                    responseTime,
                    details: error.message
                });
                addTestStep(`âŒ ${name} - å¤±è´¥: ${error.message}`, 'failed');
                return false;
            }
        }

        // å®Œæ•´æµ‹è¯•æµç¨‹
        async function runCompleteTest() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            
            testResults = [];
            document.getElementById('testProgress').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
            
            addTestStep('å¼€å§‹å®Œæ•´åŠŸèƒ½æµ‹è¯•...', 'info');

            // æµ‹è¯•1: å¥åº·æ£€æŸ¥
            await runTest('å¥åº·æ£€æŸ¥', async () => {
                const response = await axios.get(`${baseURL}/api/categories/health`, { timeout: 5000 });
                if (response.data.success && response.data.data === 'åˆ†ç±»æ¨¡å—è¿è¡Œæ­£å¸¸') {
                    return 'æœåŠ¡æ­£å¸¸è¿è¡Œ';
                }
                throw new Error('å¥åº·æ£€æŸ¥å“åº”å¼‚å¸¸');
            });

            // æµ‹è¯•2: åŸºç¡€åˆ†ç±»æŸ¥è¯¢
            await runTest('åŸºç¡€åˆ†ç±»æŸ¥è¯¢', async () => {
                const response = await axios.get(`${baseURL}/api/categories`, {
                    params: { pageNum: 1, pageSize: 5 },
                    timeout: 10000
                });
                if (response.data.success && response.data.data.categories) {
                    return `è·å–åˆ° ${response.data.data.categories.length} æ¡è®°å½•ï¼Œæ€»è®¡ ${response.data.data.total} æ¡`;
                }
                throw new Error('åˆ†ç±»æŸ¥è¯¢å¤±è´¥');
            });

            // æµ‹è¯•3: å¸¦å‚æ•°çš„åˆ†ç±»æŸ¥è¯¢
            await runTest('å‚æ•°åŒ–æŸ¥è¯¢', async () => {
                const response = await axios.get(`${baseURL}/api/categories`, {
                    params: { 
                        pageNum: 1, 
                        pageSize: 3,
                        sortBy: 'category_name',
                        sortDir: 'desc',
                        includeStatistics: true
                    },
                    timeout: 10000
                });
                if (response.data.success) {
                    return `æ’åºæŸ¥è¯¢æˆåŠŸï¼Œè·å– ${response.data.data.categories.length} æ¡è®°å½•`;
                }
                throw new Error('å‚æ•°åŒ–æŸ¥è¯¢å¤±è´¥');
            });

            // æµ‹è¯•4: åˆ†ç±»æ ‘æŸ¥è¯¢
            await runTest('åˆ†ç±»æ ‘æŸ¥è¯¢', async () => {
                const response = await axios.get(`${baseURL}/api/categories/tree`, {
                    params: { includeInactive: false },
                    timeout: 10000
                });
                if (response.data.success) {
                    return `æ ‘å½¢ç»“æ„æŸ¥è¯¢æˆåŠŸï¼Œè·å– ${response.data.data.length} ä¸ªé¡¶çº§åˆ†ç±»`;
                }
                throw new Error('åˆ†ç±»æ ‘æŸ¥è¯¢å¤±è´¥');
            });

            // æµ‹è¯•5: CORSè·¨åŸŸæµ‹è¯•
            await runTest('CORSè·¨åŸŸéªŒè¯', async () => {
                const response = await fetch(`${baseURL}/api/categories/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });
                if (response.ok) {
                    const corsHeaders = {
                        'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                        'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods')
                    };
                    return `CORSé…ç½®æ­£ç¡®: ${JSON.stringify(corsHeaders)}`;
                }
                throw new Error(`CORSå¤±è´¥: ${response.status}`);
            });

            // æµ‹è¯•6: é”™è¯¯å¤„ç†æµ‹è¯•
            await runTest('é”™è¯¯å¤„ç†éªŒè¯', async () => {
                try {
                    await axios.get(`${baseURL}/api/categories/999999`, { timeout: 5000 });
                    throw new Error('åº”è¯¥è¿”å›404é”™è¯¯');
                } catch (error) {
                    if (error.response && error.response.status === 404) {
                        return 'é”™è¯¯å¤„ç†æ­£ç¡®';
                    }
                    throw error;
                }
            });

            addTestStep('æµ‹è¯•å®Œæˆï¼Œç”Ÿæˆç»“æœæŠ¥å‘Š...', 'info');
            showTestResults();
            
            btn.disabled = false;
            btn.textContent = 'é‡æ–°æµ‹è¯•';
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = function() {
            showEnvironmentInfo();
            addTestStep('æµ‹è¯•å·¥å…·å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹å®Œæ•´æµ‹è¯•"è¿›è¡ŒéªŒè¯', 'info');
        };
    </script>
</body>
</html> 